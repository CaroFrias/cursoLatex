# Nuestras propias macros

Hoy vamos a salir de mi zona de confort y hablar sobre la creación de
[*macros*], es decir, de nuevos comandos y entornos[^macro]. No soy
ninguna experta en esto, pero hay un par de ideas que me parece que
hay que tener claras a la hora de definir cosas en LaTeX. Básicamente
voy a contar lo que me hubiera gustado que me contaran cuando empecé
con esto, más que nada para no copiar de StackOverflow a ciegas.

[*macros*]: http://foldoc.org/macro

[^macro]: ¡Líos de nomenclatura a la vista! Dijimos hace mucho que
LaTeX es un *conjunto de macros* para TeX. Luego hemos separado estas
*macros* en comandos y entornos, pero un entorno no deja de ser un
conjunto de comandos que afecta de forma local. Llamaremos también
*macro* a los comandos (y por extensión entornos) que *definamos
nosotros*, tal y como se suele hacer en el mundillo.

Lo primero y más importante que tenemos que saber a la hora de jugar
con las macros en LaTeX es que tenemos dos opciones[^provide]:

* **Crear un entorno o comando desde cero**. Así conseguimos que LaTeX
  haga algo que no hacía o guardamos un conjunto de órdenes que usamos
  a menudo en una macro con el objetivo escribir menos. La palabra
  clave para esto es *new*.

* **Pisar un entorno o comando existente**. En este caso la idea es
  modificar el comportamiento de cierto comando o entorno a nuestro
  gusto. Se conoce como *renew*.

[^provide]: Para ser sinceros también está `\providecommand`, que crea
el comando si no existe y si no ignora la definición, pero no tiene un
[primo para los entornos][primo].

[primo]: https://tex.stackexchange.com/questions/56667/why-is-there-no-provideenvironment

El siguiente concepto en orden de importancia es que podemos
(re)definir comandos en cualquier parte del documento, pero para tener
todo perfectamente organizado es preferible hacerlo en el preámbulo.

Veamos entonces como crear comandos y entornos nuevos y modificar los
existentes. Voy a intentar que todos los ejemplos resuelvan
problemas reales, que no sean *de juguete*.

## Escribir comandos

Han ido apareciendo comandos nuevos[^new] y trucados[^renew]
anteriormente, ¡hoy llega por fin la explicación que os debía! Primero
vamos a fabricar comandos nuevecitos, luego modificaremos alguno que
ya existe para que sea más divertido.

[^new]: Cuando aprendimos a escribir [ecuaciones] vimos un truco para
no tener que escribir la palabra *Ecuación* a la hora de referenciar.
[^renew]: Cuando hablamos del [idioma] vimos como modificar el nombre
de las tablas.

[idioma]: https://ondiz.github.io/cursoLatex/Contenido/06.Idioma.html
[ecuaciones]: https://ondiz.github.io/cursoLatex/Contenido/05.Ecuaciones.html

### Comandos nuevos

Definir comandos nuevos en LaTeX es sencillo, solo debemos seguir la
siguiente estructura:

```latex
\newcommand{COMANDO}[ARGUMENTOS]{DEFINICIÓN}
```

donde:

* `COMANDO` será el nombre del comando que queramos definir. Empezará
  por `\`. Solo podemos usar letras para bautizarlo.

* `ARGUMENTOS` es el número de argumentos entre 0 y 9 que le pasaremos
  al comando. Como veis, que un comando tenga argumentos es opcional.
  
* `DEFINICIÓN` será donde escribiremos lo que hace el comando. Haremos
  referencia a los diferentes argumentos mediante `#` seguida del
  número correspondiente.

Veamos un ejemplo. Vamos a crear un comando que nos escriba `Figura X`
en lugar de `X` cuando hagamos referencia a cierta figura:

```latex
\newcommand{\figref}[1]{\figurename~\ref{#1}}
```

Analicémoslo:

* El nombre del nuevo comando es `\figref{}` y tiene un único
  argumento, la etiqueta de la figura, a la que hacemos referencia
  gracias a nuestro viejo conocido `\ref{}`.

* `\figurename` es el comando que guarda el nombre de las
  figuras[^name]. Podríamos escribir *Figura* a mano, pero si
  cambiamos el idioma tendríamos que cambiar también la definición. De
  este modo LaTeX sustituye `\figurename` por el nombre de la figura
  según el paquete de idioma.
  
* Usamos un *espacio duro* entre el nombre y el número para que LaTeX
  no meta en medio un salto de línea o de página.

Nuestra nueva macro se usa exactamente igual que cualquier otro
comando:

```latex
\begin{figure}[H]
  \includegraphics[width=0.7\textwidth]{Figuras/esquema.eps}
  \caption{Esquema del proceso}
  \label{fig:esquema}
\end{figure}

Como vemos en la \figref{fig:esquema}...

% Equivalente a 
Como vemos en la Figura~\ref{fig:esquema}...
```

[^name]: De manera equivalente tenemos `\tablename` para el nombre de
las tablas, `\chaptername` para los capítulo [y demás][fixed].

[fixed]: http://www.tex.ac.uk/FAQ-fixnam.html

Un tema interesante a la hora de definir comandos son los **argumentos
por defecto**

```latex
\newcommand{COMANDO}[ARGUMENTOS][DEFECTO]{DEFINICIÓN}
```

donde `DEFECTO` es el valor que tomará el argumento opcional si
no se especifica. El argumento opcional siempre es el primero.

Un ejemplo de uso

que hagamos referencia al plano real a menudo pero tal vez nos haga
falta alguna vez hablar de un espacio de dimensión mayor. Para ello
podemos definir un comando que nos escriba la R molona y que por
defecto el espacio sea bidimensional, pero podamos cambiarlo.

```latex
\usepackage{amssymb}
\newcommand{\planoR}[1][2]{\mathbb{R}^{#1}}
```

A la hora de usarlo:

```latex
% Espacio bidimensional
$\planoR$

% Espacio tridimensional
$\planoR[3]$
```

### Comandos trucados

Hemos dicho al principio que además de crear nuestros propios comandos
podemos modificar el comportamiento de alguno existente. Para ello
usamos `\renewcommand` en lugar de `\newcommand` con la misma sintaxis

```latex
\renewcommand{COMANDO}[ARGUMENTOS]{DEFINICIÓN}
```

donde:

* `COMANDO` será el nombre del comando que queramos modificar. 

* `ARGUMENTOS` es el número de argumentos, igual que antes.
  
* `DEFINICIÓN` será la nueva definición del comando.

Como ejemplo de esta sección, vamos a usar `\renewcommand` para evitar
tener que activar el modo matemático cuando escribamos fracciones. Con
este fin vamos a echar mano de [`\ensuremath{}`], que nos permite usar
comandos matemáticos dentro y fuera de las ecuaciones[^ensure].

[`\ensuremath`]: http://ceadserv1.nku.edu/longa//public_html/latex/html/ensuremath.html

[^ensure]: Ahora no nos vengamos arriba y nos pongamos usar
`\ensuremath` a mansalva. [Aquí][criterio] hay algunos criterios.

[criterio]: https://tex.stackexchange.com/questions/34830/when-not-to-use-ensuremath-for-math-macro

Como vamos a crear la nueva definición a partir del propio comando,
necesitamos guardarlo en otro sitio primero para que la definición no
sea recursiva. En este menester nos ayuda el comando [`\let`], que
sirve para copiar el contenido de un comando en uno nuevo:

```latex
\let\comandoNuevo=\comandoViejo
```

[`\let`]: https://en.wikibooks.org/wiki/TeX/let

Juntando las piezas, tenemos lo siguiente:

```latex
% Guardamos la definición original
\let\oldfrac=\frac
% Modificamos \frac para que funcione fuera de ecuaciones
\renewcommand{\frac}[2]{\ensuremath{\oldfrac{#1}{#2}}}
```

Ahora podemos usar `\frac` directamente en el texto. 

## Escribir entornos

Ahora que ya sabemos crear y cambiar comandos vamos a dar un paso más
y hacer los mismo para los entornos.

### Entornos nuevos

La sintaxis para la definición de entornos nuevos es muy similar a la
de los comandos, usando ahora `\newenvironment`:

```latex
\newenvironment{COMANDO}[ARGUMENTOS]{ANTES}{DESPUÉS}
```

Donde `ANTES` y `DESPUÉS` son el grupo de comandos que hay que
ejecutar al iniciar el entorno y, por tanto, los que le darán el
formato al mismo, y `DESPUÉS` los que se activarán tras el texto. El
resto de elementos funciona como antes.

Entornos numerados

[contador]: https://www.sharelatex.com/learn/Counters

```latex
% Creamos un nuevo contador que se reinicie al cambiar de sección
\newcounter{example}[section]
\newenvironment{example}[1][]{\refstepcounter{example}}{}
```

### Entornos trucados

Modificación de un entorno

Una modificación compleja para que LaTeX nos muestre las citas en gris
con una barra gris clara a la izquierda.

```latex
{% raw %}
\usepackage{framed}

% Redefinir leftbar
\renewenvironment{leftbar}[1][\hsize]
  { \color{gray}
      \def\FrameCommand
      {{\color{lightgray}\vrule width 3pt}}
      \MakeFramed{\hsize#1\advance\hsize-\width\FrameRestore}
  }
  {\endMakeFramed}
  
% Guardar entorno quote
\let\oldquote=\quote
\let\oldendquote=\endquote

% Barra vertical a la izquierda de la cita
\renewenvironment{quote}
    {\vspace{10pt}\leftbar\vspace*{-6pt}\oldquote}
    {\oldendquote\endleftbar\vspace{10pt}}
{% endraw %}
```

<!-- IMAGEN -->

* Usa el paquete `framed`
* `leftbar` tiene un argumento, por defecto `\hsize`
* `\def`
* Como `quote` es un entorno, hay que guardar los comandos de *antes*
  y *después*.

## Una nota sobre TeX

TeX o Plain TeX

* Limitaciones de LaTeX / mayores capacidades de TeX al ser este
  último de nivel más bajo.
* `\let` pertenece a TeX
* Otros comandos útiles como `\def`

# Resumen

* Definir vs pisar. Usos
* Comando vs entorno
* Preámbulo
* `\let`, `\def`
* Mi recomendación: escribir la secuencia de comandos que queramos
  guardar en el documento, probar si funciona, extraer los argumentos,
  pensar si necesitamos un argumento opcional.

# Referencias

[*LaTeX example: How to create your own commands with `newcommand`*](http://alvinalexander.com/blog/post/latex/create-your-own-commands-in-latex-using-newcommand)

[*LaTeX/Macros* en Wikibooks](https://en.wikibooks.org/wiki/LaTeX/Macros)

[*`\newcommand` with arguments in LaTeX*](http://www.shawnlankton.com/2008/01/newcommand-with-argument-in-latex/)

[*Plain TeX vs. LaTeX Macros* en TeXExchange](https://tex.stackexchange.com/questions/35564/plain-tex-vs-latex-macros)

[*LaTeX/Plain TeX* en Wikibooks](https://en.wikibooks.org/wiki/LaTeX/Plain_TeX)

[*List of higher-level LaTeX commands corresponding to TeX commands* en TeXExchange](https://tex.stackexchange.com/questions/26742/list-of-higher-level-latex-commands-corresponding-to-tex-commands/26922#26922)

